# ä¹è°±éªŒè¯ç³»ç»Ÿ - å®Œæ•´éƒ¨ç½²æŒ‡å—

## ðŸŽ¯ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ åœ¨å…¨æ–°çš„Ubuntu 22.04 VPSä¸Šéƒ¨ç½²ä¹è°±äºŒç»´ç éªŒè¯ç³»ç»Ÿï¼ŒåŒ…æ‹¬æœåŠ¡å™¨è¿ç§»çš„å®Œæ•´æµç¨‹ã€‚

## ðŸ“‹ ç³»ç»Ÿè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- **CPU**: 1æ ¸å¿ƒï¼ˆæŽ¨è2æ ¸å¿ƒï¼‰
- **å†…å­˜**: 1GBï¼ˆæŽ¨è2GBï¼‰
- **å­˜å‚¨**: 10GBå¯ç”¨ç©ºé—´ï¼ˆæŽ¨è20GBï¼‰
- **ç½‘ç»œ**: å…¬ç½‘IPåœ°å€

### è½¯ä»¶è¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS
- **åŸŸå**: ç”¨äºŽHTTPSè®¿é—®ï¼ˆå¯é€‰ä½†æŽ¨èï¼‰
- **SSHè®¿é—®**: ç®¡ç†å‘˜æƒé™

## ðŸš€ ä¸€é”®éƒ¨ç½²ï¼ˆæŽ¨èï¼‰

### 1. å‡†å¤‡å·¥ä½œ

```bash
# è¿žæŽ¥åˆ°VPS
ssh root@your-vps-ip

# æ›´æ–°ç³»ç»Ÿ
apt update && apt upgrade -y

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
adduser musicqr
usermod -aG sudo musicqr
su - musicqr
```

### 2. ä¸‹è½½é¡¹ç›®

```bash
# æ–¹æ³•1: ç›´æŽ¥ä¸‹è½½ï¼ˆå¦‚æžœæœ‰åŽ‹ç¼©åŒ…ï¼‰
wget https://your-domain.com/musicqr-vps.tar.gz
tar -xzf musicqr-vps.tar.gz
cd ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ

# æ–¹æ³•2: ä½¿ç”¨gitï¼ˆå¦‚æžœæœ‰ä»“åº“ï¼‰
git clone https://github.com/your-repo/musicqr-vps.git
cd musicqr-vps

æ–¹æ³•3: æ‰‹åŠ¨ä¸Šä¼ 
ä½¿ç”¨scpä¸Šä¼ æ•´ä¸ªé¡¹ç›®ç›®å½•
scp -r ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ/ musicqr@your-vps-ip:/home/musicqr/
```

### 3. è¿è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ

# è¿è¡Œéƒ¨ç½²è„šæœ¬
chmod +x server/deploy/setup.sh
sudo ./server/deploy/setup.sh
```

éƒ¨ç½²è„šæœ¬å°†è‡ªåŠ¨å®Œæˆï¼š
- âœ… å®‰è£…ç³»ç»Ÿä¾èµ–
- âœ… é…ç½®PythonçŽ¯å¢ƒ
- âœ… éƒ¨ç½²åº”ç”¨ä»£ç 
- âœ… é…ç½®æ•°æ®åº“
- âœ… è®¾ç½®systemdæœåŠ¡
- âœ… é…ç½®Nginx
- âœ… è®¾ç½®é˜²ç«å¢™
- âœ… å¯åŠ¨æ‰€æœ‰æœåŠ¡

### 4. é…ç½®åŸŸåå’ŒSSL

```bash
# é…ç½®åŸŸåDNSè§£æž
# åœ¨åŸŸåç®¡ç†é¢æ¿æ·»åŠ Aè®°å½•ï¼š
# ç±»åž‹: A
# åç§°: verify.yuzeguitar.me
# å€¼: your-vps-ip

# ç­‰å¾…DNSç”Ÿæ•ˆåŽï¼Œé…ç½®SSLè¯ä¹¦
sudo certbot --nginx -d verify.yuzeguitar.me
```

## ðŸ”§ æ‰‹åŠ¨éƒ¨ç½²ï¼ˆè¯¦ç»†æ­¥éª¤ï¼‰

å¦‚æžœä¸€é”®éƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨éƒ¨ç½²ï¼š

### 1. å®‰è£…ç³»ç»Ÿä¾èµ–

```bash
sudo apt update
sudo apt install -y python3 python3-pip python3-venv nginx sqlite3 git curl wget unzip htop ufw certbot python3-certbot-nginx
```

### 2. åˆ›å»ºç›®å½•ç»“æž„

```bash
sudo mkdir -p /var/www/musicqr
sudo mkdir -p /var/lib/musicqr
sudo mkdir -p /var/log/musicqr
sudo mkdir -p /var/backups/musicqr

sudo chown -R musicqr:musicqr /var/www/musicqr
sudo chown -R musicqr:musicqr /var/lib/musicqr
sudo chown -R musicqr:musicqr /var/log/musicqr
sudo chown -R musicqr:musicqr /var/backups/musicqr
```

### 3. éƒ¨ç½²åº”ç”¨ä»£ç 

```bash
# å¤åˆ¶æœåŠ¡å™¨ä»£ç 
cp -r server/* /var/www/musicqr/
cp -r web/ /var/www/musicqr/

# è®¾ç½®Pythonè™šæ‹ŸçŽ¯å¢ƒ
cd /var/www/musicqr
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 4. é…ç½®çŽ¯å¢ƒå˜é‡

```bash
# ç”Ÿæˆéšæœºå¯†é’¥
SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_hex(32))")

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /var/www/musicqr/.env << EOF
FLASK_ENV=production
SECRET_KEY=$SECRET_KEY
API_KEY_SALT=musicqr_api_salt_2024
DATABASE_PATH=/var/lib/musicqr/musicqr.db
LOG_FILE=/var/log/musicqr/api.log
BACKUP_DIR=/var/backups/musicqr
ADMIN_USERNAME=admin
ADMIN_PASSWORD=musicqr2024
EOF

chmod 600 /var/www/musicqr/.env
echo "ç”Ÿæˆçš„SECRET_KEY: $SECRET_KEY"
```

### 5. åˆå§‹åŒ–æ•°æ®åº“

```bash
cd /var/www/musicqr
source venv/bin/activate
python3 -c "from models import init_db; init_db('/var/lib/musicqr/musicqr.db')"
```

### 6. é…ç½®systemdæœåŠ¡

```bash
sudo cp server/deploy/systemd.service /etc/systemd/system/musicqr-api.service

# æˆ–æ‰‹åŠ¨åˆ›å»º
sudo tee /etc/systemd/system/musicqr-api.service > /dev/null << EOF
[Unit]
Description=Music QR Code Verification API
After=network.target

[Service]
Type=exec
User=musicqr
Group=musicqr
WorkingDirectory=/var/www/musicqr
Environment=PATH=/var/www/musicqr/venv/bin
EnvironmentFile=/var/www/musicqr/.env
ExecStart=/var/www/musicqr/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 2 app:app
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable musicqr-api
sudo systemctl start musicqr-api
```

### 7. é…ç½®Nginx

```bash
sudo cp server/deploy/nginx.conf /etc/nginx/sites-available/musicqr

# æˆ–æ‰‹åŠ¨åˆ›å»º
sudo tee /etc/nginx/sites-available/musicqr > /dev/null << 'EOF'
server {
    listen 80;
    server_name verify.yuzeguitar.me;
    
    # ç®¡ç†åŽå°è·¯ç”±
    location /admin {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # APIè·¯ç”±
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/musicqr/web;
        try_files $uri $uri/ /index.html;
        
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    access_log /var/log/nginx/musicqr_access.log;
    error_log /var/log/nginx/musicqr_error.log;
}
EOF

# å¯ç”¨ç«™ç‚¹
sudo ln -sf /etc/nginx/sites-available/musicqr /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t
sudo systemctl restart nginx
```

### 8. é…ç½®é˜²ç«å¢™

```bash
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw --force enable
```

## ðŸ”„ æœåŠ¡å™¨è¿ç§»æŒ‡å—

### 1. å¤‡ä»½åŽŸæœåŠ¡å™¨æ•°æ®

```bash
# åœ¨åŽŸæœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /var/www/musicqr

# å¤‡ä»½æ•°æ®åº“
cp /var/lib/musicqr/musicqr.db ./musicqr_backup.db

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp .env env_backup

# åˆ›å»ºå®Œæ•´å¤‡ä»½
tar -czf musicqr_backup_$(date +%Y%m%d_%H%M%S).tar.gz \
    musicqr_backup.db \
    env_backup \
    /var/log/musicqr/ \
    /var/backups/musicqr/

# ä¸‹è½½å¤‡ä»½æ–‡ä»¶åˆ°æœ¬åœ°
scp musicqr@old-server-ip:/var/www/musicqr/musicqr_backup_*.tar.gz ./
```

### 2. åœ¨æ–°æœåŠ¡å™¨ä¸Šéƒ¨ç½²

```bash
# æŒ‰ç…§ä¸Šè¿°éƒ¨ç½²æ­¥éª¤åœ¨æ–°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ç³»ç»Ÿ

# ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
scp musicqr_backup_*.tar.gz musicqr@new-server-ip:/home/musicqr/

# åœ¨æ–°æœåŠ¡å™¨ä¸Šè§£åŽ‹
tar -xzf musicqr_backup_*.tar.gz
```

### 3. æ¢å¤æ•°æ®

```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop musicqr-api

# æ¢å¤æ•°æ®åº“
cp musicqr_backup.db /var/lib/musicqr/musicqr.db
chown musicqr:musicqr /var/lib/musicqr/musicqr.db

# æ¢å¤é…ç½®ï¼ˆå¯é€‰ï¼Œæˆ–ä½¿ç”¨æ–°é…ç½®ï¼‰
cp env_backup /var/www/musicqr/.env

# å¯åŠ¨æœåŠ¡
sudo systemctl start musicqr-api
```

### 4. æ›´æ–°DNSè§£æž

```bash
# åœ¨åŸŸåç®¡ç†é¢æ¿æ›´æ–°Aè®°å½•
# å°†åŸŸåæŒ‡å‘æ–°æœåŠ¡å™¨IP
# ç­‰å¾…DNSä¼ æ’­ï¼ˆé€šå¸¸5-30åˆ†é’Ÿï¼‰

# éªŒè¯DNSè§£æž
nslookup verify.yuzeguitar.me
```

### 5. é‡æ–°ç”³è¯·SSLè¯ä¹¦

```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Šç”³è¯·SSLè¯ä¹¦
sudo certbot --nginx -d verify.yuzeguitar.me
```

## âœ… éƒ¨ç½²éªŒè¯

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥APIæœåŠ¡
sudo systemctl status musicqr-api

# æ£€æŸ¥NginxæœåŠ¡
sudo systemctl status nginx

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep -E ':(80|443|5000)'
```

### 2. æµ‹è¯•åŠŸèƒ½

```bash
# æµ‹è¯•APIæŽ¥å£
curl http://localhost:5000/api/status
curl https://verify.yuzeguitar.me/api/status

# æµ‹è¯•å‰ç«¯é¡µé¢
curl -I https://verify.yuzeguitar.me/

# æµ‹è¯•ç®¡ç†åŽå°
curl -I https://verify.yuzeguitar.me/admin
```

### 3. è¿è¡Œç³»ç»Ÿæµ‹è¯•

```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬
cd /home/musicqr/ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ
python3 scripts/test_system.py --url https://verify.yuzeguitar.me
```

## ðŸ”§ é…ç½®å®¢æˆ·ç«¯

### 1. èŽ·å–APIå¯†é’¥

```bash
# åœ¨VPSä¸ŠèŽ·å–å¯†é’¥
cd /var/www/musicqr
cat .env | grep SECRET_KEY
```

### 2. é…ç½®æœ¬åœ°å®¢æˆ·ç«¯

```bash
# åœ¨æœ¬åœ°å®¢æˆ·ç«¯ç›®å½•
export VPS_URL='https://verify.yuzeguitar.me'
export CLIENT_SECRET_KEY='your-secret-key-from-server'
export API_KEY_SALT='musicqr_api_salt_2024'

# æµ‹è¯•è¿žæŽ¥
python3 generate_codes.py
```

## ðŸ“Š ç³»ç»Ÿç®¡ç†

### æ—¥å¸¸ç»´æŠ¤å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status musicqr-api nginx

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u musicqr-api -f
sudo tail -f /var/log/nginx/musicqr_access.log

# é‡å¯æœåŠ¡
sudo systemctl restart musicqr-api nginx

# å¤‡ä»½æ•°æ®åº“
cp /var/lib/musicqr/musicqr.db /var/backups/musicqr/backup_$(date +%Y%m%d).db
```

### æ›´æ–°ç³»ç»Ÿ

```bash
# æ›´æ–°ä»£ç 
cd /home/musicqr/ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ
git pull  # å¦‚æžœä½¿ç”¨git

# è¿è¡Œæ›´æ–°è„šæœ¬
chmod +x server/deploy/update.sh
./server/deploy/update.sh
```

## ðŸ› æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   sudo journalctl -u musicqr-api -n 50
   ```

2. **Nginxé…ç½®é”™è¯¯**
   ```bash
   sudo nginx -t
   sudo tail -f /var/log/nginx/error.log
   ```

3. **æ•°æ®åº“æƒé™é—®é¢˜**
   ```bash
   sudo chown musicqr:musicqr /var/lib/musicqr/musicqr.db
   ```

4. **ç«¯å£è¢«å ç”¨**
   ```bash
   sudo netstat -tlnp | grep :5000
   ```

### ç´§æ€¥æ¢å¤

```bash
# å¦‚æžœç³»ç»Ÿå®Œå…¨æ— æ³•è®¿é—®ï¼Œä½¿ç”¨å¤‡ä»½æ¢å¤
sudo systemctl stop musicqr-api nginx
cp /var/backups/musicqr/latest_backup.db /var/lib/musicqr/musicqr.db
sudo systemctl start musicqr-api nginx
```

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **å¼€å‘è€…**: Yuze Pan
- **å¾®ä¿¡**: Guitar_yuze
- **ç‰ˆæœ¬**: v2.0.0

---

**éƒ¨ç½²æˆåŠŸåŽï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„ä¹è°±éªŒè¯ç³»ç»Ÿï¼** ðŸŽ‰
