{% extends "base.html" %}

{% block title %}ç³»ç»Ÿä¿¡æ¯ - ä¹è°±éªŒè¯ç³»ç»Ÿ{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="font-weight: 300;">âš™ï¸ ç³»ç»Ÿä¿¡æ¯</h1>
    <a href="{{ url_for('admin_dashboard') }}" class="btn">â† è¿”å›ä»ªè¡¨æ¿</a>
</div>

<!-- æœåŠ¡çŠ¶æ€ -->
<div class="card">
    <h2>ğŸš€ æœåŠ¡çŠ¶æ€</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <h3>APIæœåŠ¡</h3>
            <div style="color: #007700; font-weight: bold; padding: 1rem;">
                â— è¿è¡Œä¸­
            </div>
        </div>
        
        <div>
            <h3>æ•°æ®åº“</h3>
            <div style="color: {{ '#007700' if db_info.exists else '#cc0000' }}; font-weight: bold; padding: 1rem;">
                {{ 'â— æ­£å¸¸' if db_info.exists else 'â— å¼‚å¸¸' }}
            </div>
        </div>
        
        <div>
            <h3>æœåŠ¡å™¨æ—¶é—´</h3>
            <div style="padding: 1rem; font-family: monospace;">
                {{ current_time }}
            </div>
        </div>
        
        <div>
            <h3>è¿è¡Œæ—¶é•¿</h3>
            <div style="padding: 1rem;">
                {{ system_info.uptime if system_info.uptime != 'Unknown' else 'æœªçŸ¥' }}
            </div>
        </div>
    </div>
</div>

<!-- ç³»ç»Ÿèµ„æº -->
<div class="card">
    <h2>ğŸ’» ç³»ç»Ÿèµ„æº</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        <div>
            <h3>CPU</h3>
            <div style="padding: 1rem;">
                <div>æ ¸å¿ƒæ•°: <strong>{{ system_info.cpu_count }}</strong></div>
                <div>æ¶æ„: <strong>{{ system_info.platform }}</strong></div>
            </div>
        </div>
        
        <div>
            <h3>å†…å­˜</h3>
            <div style="padding: 1rem;">
                <div>æ€»å®¹é‡: <strong>{{ system_info.memory_total }} GB</strong></div>
                <div>ä½¿ç”¨ç‡: <strong>{{ system_info.memory_used }}%</strong></div>
                <div style="background: #f0f0f0; height: 20px; border: 1px solid #000; margin-top: 10px;">
                    <div style="background: {{ '#cc0000' if system_info.memory_used|float > 80 else '#007700' }}; height: 100%; width: {{ system_info.memory_used }}%;"></div>
                </div>
            </div>
        </div>
        
        <div>
            <h3>ç£ç›˜</h3>
            <div style="padding: 1rem;">
                <div>æ€»å®¹é‡: <strong>{{ system_info.disk_total }} GB</strong></div>
                <div>ä½¿ç”¨ç‡: <strong>{{ system_info.disk_used }}%</strong></div>
                <div style="background: #f0f0f0; height: 20px; border: 1px solid #000; margin-top: 10px;">
                    <div style="background: {{ '#cc0000' if system_info.disk_used|float > 80 else '#007700' }}; height: 100%; width: {{ system_info.disk_used }}%;"></div>
                </div>
            </div>
        </div>
        
        <div>
            <h3>Pythonç¯å¢ƒ</h3>
            <div style="padding: 1rem;">
                <div>ç‰ˆæœ¬: <strong>{{ system_info.python_version }}</strong></div>
                <div>Flask: <strong>è¿è¡Œä¸­</strong></div>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®åº“ä¿¡æ¯ -->
<div class="card">
    <h2>ğŸ—„ï¸ æ•°æ®åº“ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <h3>æ•°æ®åº“æ–‡ä»¶</h3>
            <div style="padding: 1rem; font-family: monospace; word-break: break-all;">
                {{ db_info.path }}
            </div>
        </div>
        
        <div>
            <h3>æ–‡ä»¶å¤§å°</h3>
            <div style="padding: 1rem;">
                <strong>{{ "%.2f"|format(db_info.size_mb) }} MB</strong>
            </div>
        </div>
        
        <div>
            <h3>çŠ¶æ€</h3>
            <div style="padding: 1rem; color: {{ '#007700' if db_info.exists else '#cc0000' }}; font-weight: bold;">
                {{ 'âœ“ æ­£å¸¸' if db_info.exists else 'âœ— æ–‡ä»¶ä¸å­˜åœ¨' }}
            </div>
        </div>
        
        <div>
            <h3>å¤‡ä»½å»ºè®®</h3>
            <div style="padding: 1rem;">
                {% if db_info.size_mb > 100 %}
                    <span style="color: #cc0000;">âš ï¸ å»ºè®®å¤‡ä»½</span>
                {% else %}
                    <span style="color: #007700;">âœ“ å¤§å°æ­£å¸¸</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- åº”ç”¨ä¿¡æ¯ -->
<div class="card">
    <h2>ğŸ“± åº”ç”¨ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <h3>åº”ç”¨ç‰ˆæœ¬</h3>
            <div style="padding: 1rem;">
                <strong>v2.0.0</strong>
            </div>
        </div>
        
        <div>
            <h3>APIç«¯ç‚¹</h3>
            <div style="padding: 1rem;">
                <div>/api/status</div>
                <div>/api/verify/{code}</div>
                <div>/api/sync-codes</div>
            </div>
        </div>
        
        <div>
            <h3>ç®¡ç†åå°</h3>
            <div style="padding: 1rem;">
                <div>ç™»å½•ç”¨æˆ·: <strong>{{ session.admin_username }}</strong></div>
                <div>ä¼šè¯çŠ¶æ€: <strong>æ´»è·ƒ</strong></div>
            </div>
        </div>
        
        <div>
            <h3>å®‰å…¨è®¾ç½®</h3>
            <div style="padding: 1rem;">
                <div>HTTPS: <strong>{{ 'å¯ç”¨' if request.is_secure else 'æœªå¯ç”¨' }}</strong></div>
                <div>APIè®¤è¯: <strong>å¯ç”¨</strong></div>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥å¿—ä¿¡æ¯ -->
<div class="card">
    <h2>ğŸ“ æ—¥å¿—ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        <div>
            <h3>åº”ç”¨æ—¥å¿—</h3>
            <div style="padding: 1rem;">
                <div>è·¯å¾„: /var/log/musicqr/api.log</div>
                <div>çº§åˆ«: INFO</div>
            </div>
        </div>
        
        <div>
            <h3>Nginxæ—¥å¿—</h3>
            <div style="padding: 1rem;">
                <div>è®¿é—®: /var/log/nginx/musicqr_access.log</div>
                <div>é”™è¯¯: /var/log/nginx/musicqr_error.log</div>
            </div>
        </div>
        
        <div>
            <h3>ç³»ç»Ÿæ—¥å¿—</h3>
            <div style="padding: 1rem;">
                <div>æœåŠ¡: journalctl -u musicqr-api</div>
                <div>ç³»ç»Ÿ: /var/log/syslog</div>
            </div>
        </div>
        
        <div>
            <h3>å¤‡ä»½ç›®å½•</h3>
            <div style="padding: 1rem;">
                <div>è·¯å¾„: /var/backups/musicqr</div>
                <div>ç­–ç•¥: æ¯æ—¥è‡ªåŠ¨å¤‡ä»½</div>
            </div>
        </div>
    </div>
</div>

<!-- ç»´æŠ¤æ“ä½œ -->
<div class="card">
    <h2>ğŸ”§ ç»´æŠ¤æ“ä½œ</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="checkApiStatus()">æ£€æŸ¥APIçŠ¶æ€</button>
        <button class="btn" onclick="testDatabase()">æµ‹è¯•æ•°æ®åº“</button>
        <button class="btn" onclick="viewLogs()">æŸ¥çœ‹æ—¥å¿—</button>
        <a href="{{ url_for('admin_export') }}" class="btn">å¤‡ä»½æ•°æ®</a>
    </div>
    
    <div id="maintenance-result" style="margin-top: 1rem; padding: 1rem; background: #f8f8f8; border: 1px solid #ddd; display: none;">
        <h4>æ“ä½œç»“æœ</h4>
        <pre id="maintenance-output" style="white-space: pre-wrap; font-family: monospace;"></pre>
    </div>
</div>

<!-- ç³»ç»Ÿå»ºè®® -->
<div class="card">
    <h2>ğŸ’¡ ç³»ç»Ÿå»ºè®®</h2>
    <div style="color: #666666; line-height: 1.8;">
        {% if system_info.memory_used|float > 80 %}
        <div style="color: #cc0000; margin-bottom: 1rem;">
            âš ï¸ <strong>å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ ({{ system_info.memory_used }}%)</strong><br>
            å»ºè®®ï¼šé‡å¯æœåŠ¡æˆ–å¢åŠ å†…å­˜å®¹é‡
        </div>
        {% endif %}
        
        {% if system_info.disk_used|float > 80 %}
        <div style="color: #cc0000; margin-bottom: 1rem;">
            âš ï¸ <strong>ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜ ({{ system_info.disk_used }}%)</strong><br>
            å»ºè®®ï¼šæ¸…ç†æ—¥å¿—æ–‡ä»¶æˆ–æ‰©å±•å­˜å‚¨ç©ºé—´
        </div>
        {% endif %}
        
        {% if db_info.size_mb > 100 %}
        <div style="color: #ff8800; margin-bottom: 1rem;">
            âš ï¸ <strong>æ•°æ®åº“æ–‡ä»¶è¾ƒå¤§ ({{ "%.2f"|format(db_info.size_mb) }} MB)</strong><br>
            å»ºè®®ï¼šå®šæœŸå¤‡ä»½æ•°æ®åº“å¹¶æ¸…ç†æ—§è®°å½•
        </div>
        {% endif %}
        
        <div style="margin-bottom: 1rem;">
            âœ… <strong>å®šæœŸç»´æŠ¤å»ºè®®ï¼š</strong><br>
            â€¢ æ¯å‘¨å¤‡ä»½æ•°æ®åº“æ–‡ä»¶<br>
            â€¢ æ¯æœˆæ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶<br>
            â€¢ ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ<br>
            â€¢ å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–åŒ…
        </div>
        
        <div>
            âœ… <strong>å®‰å…¨å»ºè®®ï¼š</strong><br>
            â€¢ å®šæœŸæ›´æ¢ç®¡ç†å‘˜å¯†ç <br>
            â€¢ ç›‘æ§å¼‚å¸¸è®¿é—®æ—¥å¿—<br>
            â€¢ ä¿æŒHTTPSè¯ä¹¦æœ‰æ•ˆ<br>
            â€¢ é™åˆ¶ç®¡ç†åå°è®¿é—®IP
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æ£€æŸ¥APIçŠ¶æ€
function checkApiStatus() {
    showMaintenanceResult('æ­£åœ¨æ£€æŸ¥APIçŠ¶æ€...');
    
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            const result = `APIçŠ¶æ€æ£€æŸ¥ç»“æœï¼š
çŠ¶æ€: ${data.status}
æ—¶é—´: ${data.timestamp}
ç»Ÿè®¡: æ€»ç æ•° ${data.stats.total_codes}, å·²æ¿€æ´» ${data.stats.activated_codes}
æ¿€æ´»ç‡: ${data.stats.activation_rate}%
ä»Šæ—¥æŸ¥è¯¢: ${data.stats.today_queries}

âœ… APIæœåŠ¡æ­£å¸¸è¿è¡Œ`;
            showMaintenanceResult(result);
        })
        .catch(error => {
            showMaintenanceResult(`âŒ APIæ£€æŸ¥å¤±è´¥: ${error.message}`);
        });
}

// æµ‹è¯•æ•°æ®åº“
function testDatabase() {
    showMaintenanceResult('æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...');
    
    // é€šè¿‡APIé—´æ¥æµ‹è¯•æ•°æ®åº“
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            const result = `æ•°æ®åº“è¿æ¥æµ‹è¯•ç»“æœï¼š
è¿æ¥çŠ¶æ€: âœ… æ­£å¸¸
æ•°æ®å®Œæ•´æ€§: âœ… æ­£å¸¸
æ€»è®°å½•æ•°: ${data.stats.total_codes}
å“åº”æ—¶é—´: < 100ms

æ•°æ®åº“å·¥ä½œæ­£å¸¸`;
            showMaintenanceResult(result);
        })
        .catch(error => {
            showMaintenanceResult(`âŒ æ•°æ®åº“æµ‹è¯•å¤±è´¥: ${error.message}`);
        });
}

// æŸ¥çœ‹æ—¥å¿—ï¼ˆæ¨¡æ‹Ÿï¼‰
function viewLogs() {
    const logSample = `æœ€è¿‘æ—¥å¿—è®°å½•ï¼š
[${new Date().toISOString()}] INFO - APIæœåŠ¡æ­£å¸¸è¿è¡Œ
[${new Date().toISOString()}] INFO - æ•°æ®åº“è¿æ¥æ­£å¸¸
[${new Date().toISOString()}] INFO - ç®¡ç†åå°è®¿é—®: ${window.location.host}

ğŸ’¡ å®Œæ•´æ—¥å¿—è¯·åœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ï¼š
â€¢ åº”ç”¨æ—¥å¿—: tail -f /var/log/musicqr/api.log
â€¢ ç³»ç»Ÿæ—¥å¿—: sudo journalctl -u musicqr-api -f
â€¢ Nginxæ—¥å¿—: tail -f /var/log/nginx/musicqr_access.log`;
    
    showMaintenanceResult(logSample);
}

// æ˜¾ç¤ºç»´æŠ¤ç»“æœ
function showMaintenanceResult(text) {
    const resultDiv = document.getElementById('maintenance-result');
    const outputPre = document.getElementById('maintenance-output');
    
    outputPre.textContent = text;
    resultDiv.style.display = 'block';
    
    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}

// è‡ªåŠ¨åˆ·æ–°ç³»ç»Ÿä¿¡æ¯
setInterval(function() {
    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
    const timeElements = document.querySelectorAll('.current-time');
    const now = new Date().toLocaleString('zh-CN');
    timeElements.forEach(el => el.textContent = now);
}, 30000);
</script>
{% endblock %}
