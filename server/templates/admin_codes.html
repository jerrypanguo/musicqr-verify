{% extends "base.html" %}

{% block title %}æˆæƒç ç®¡ç† - ä¹è°±éªŒè¯ç³»ç»Ÿ{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="font-weight: 300;">ğŸ”‘ æˆæƒç ç®¡ç†</h1>
    <div>
        <a href="{{ url_for('admin_add_code') }}" class="btn btn-primary">+ æ·»åŠ æˆæƒç </a>
        <a href="{{ url_for('admin_export') }}" class="btn">å¯¼å‡ºæ•°æ®</a>
    </div>
</div>

<!-- æœç´¢å’Œç­›é€‰ -->
<div class="card">
    <form method="GET" class="search-bar">
        <div class="form-group">
            <label for="search">æœç´¢æˆæƒç </label>
            <input type="text" id="search" name="search" placeholder="è¾“å…¥æˆæƒç ..." 
                   value="{{ request.args.get('search', '') }}">
        </div>
        <div class="form-group">
            <label for="status">çŠ¶æ€ç­›é€‰</label>
            <select id="status" name="status">
                <option value="">å…¨éƒ¨</option>
                <option value="activated" {{ 'selected' if request.args.get('status') == 'activated' }}>å·²æ¿€æ´»</option>
                <option value="not_activated" {{ 'selected' if request.args.get('status') == 'not_activated' }}>æœªæ¿€æ´»</option>
            </select>
        </div>
        <div class="form-group">
            <label for="sort">æ’åºæ–¹å¼</label>
            <select id="sort" name="sort">
                <option value="created_desc" {{ 'selected' if request.args.get('sort') == 'created_desc' }}>åˆ›å»ºæ—¶é—´â†“</option>
                <option value="created_asc" {{ 'selected' if request.args.get('sort') == 'created_asc' }}>åˆ›å»ºæ—¶é—´â†‘</option>
                <option value="activation_desc" {{ 'selected' if request.args.get('sort') == 'activation_desc' }}>æ¿€æ´»æ—¶é—´â†“</option>
                <option value="query_desc" {{ 'selected' if request.args.get('sort') == 'query_desc' }}>æŸ¥è¯¢æ¬¡æ•°â†“</option>
            </select>
        </div>
        <div>
            <button type="submit" class="btn btn-primary">æœç´¢</button>
            <a href="{{ url_for('admin_codes') }}" class="btn">é‡ç½®</a>
        </div>
    </form>
</div>

<!-- æ‰¹é‡æ“ä½œ -->
<div class="card">
    <form id="bulk-form" method="POST" action="{{ url_for('admin_bulk_action') }}">
        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
            <label>
                <input type="checkbox" id="select-all"> å…¨é€‰
            </label>
            <select name="action" required>
                <option value="">é€‰æ‹©æ“ä½œ...</option>
                <option value="delete">åˆ é™¤é€‰ä¸­</option>
                <option value="export">å¯¼å‡ºé€‰ä¸­</option>
            </select>
            <button type="submit" class="btn btn-danger" onclick="return confirm('ç¡®è®¤æ‰§è¡Œæ‰¹é‡æ“ä½œï¼Ÿ')">æ‰§è¡Œ</button>
        </div>

        <!-- æˆæƒç åˆ—è¡¨ -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="select-all-header"></th>
                        <th>æˆæƒç </th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ¿€æ´»æ—¶é—´</th>
                        <th>æŸ¥è¯¢æ¬¡æ•°</th>
                        <th>æœ€åæŸ¥è¯¢</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for code in codes %}
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_codes" value="{{ code.code }}">
                        </td>
                        <td>
                            <code style="font-weight: bold;">{{ code.code }}</code>
                        </td>
                        <td>{{ code.created_date[:19] if code.created_date else '-' }}</td>
                        <td>
                            {% if code.activated %}
                                <span style="color: #007700;">âœ“ å·²æ¿€æ´»</span>
                            {% else %}
                                <span style="color: #666666;">â—‹ æœªæ¿€æ´»</span>
                            {% endif %}
                        </td>
                        <td>{{ code.activation_date[:19] if code.activation_date else '-' }}</td>
                        <td>{{ code.query_count or 0 }}</td>
                        <td>{{ code.last_query_date[:19] if code.last_query_date else '-' }}</td>
                        <td>
                            <a href="{{ url_for('admin_code_detail', code=code.code) }}" 
                               class="btn btn-small">è¯¦æƒ…</a>
                            <a href="{{ url_for('admin_delete_code', code=code.code) }}" 
                               class="btn btn-small btn-danger"
                               onclick="return confirm('ç¡®è®¤åˆ é™¤æˆæƒç  {{ code.code }}ï¼Ÿ')">åˆ é™¤</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" style="text-align: center; color: #666666; padding: 2rem;">
                            {% if request.args.get('search') or request.args.get('status') %}
                                æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æˆæƒç 
                            {% else %}
                                æš‚æ— æˆæƒç æ•°æ®
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<!-- åˆ†é¡µ -->
{% if pagination %}
<div class="pagination">
    {% if pagination.has_prev %}
        <a href="{{ url_for('admin_codes', page=pagination.prev_num, **request.args) }}">Â« ä¸Šä¸€é¡µ</a>
    {% endif %}
    
    {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
            {% if page_num != pagination.page %}
                <a href="{{ url_for('admin_codes', page=page_num, **request.args) }}">{{ page_num }}</a>
            {% else %}
                <span class="current">{{ page_num }}</span>
            {% endif %}
        {% else %}
            <span>â€¦</span>
        {% endif %}
    {% endfor %}
    
    {% if pagination.has_next %}
        <a href="{{ url_for('admin_codes', page=pagination.next_num, **request.args) }}">ä¸‹ä¸€é¡µ Â»</a>
    {% endif %}
</div>
{% endif %}

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="card">
    <h3>ğŸ“Š å½“å‰ç­›é€‰ç»Ÿè®¡</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
        <div>æ€»æ•°: <strong>{{ total_count }}</strong></div>
        <div>å·²æ¿€æ´»: <strong>{{ activated_count }}</strong></div>
        <div>æœªæ¿€æ´»: <strong>{{ total_count - activated_count }}</strong></div>
        <div>æ¿€æ´»ç‡: <strong>{{ "%.1f"|format((activated_count / total_count * 100) if total_count > 0 else 0) }}%</strong></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨é€‰åŠŸèƒ½
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="selected_codes"]');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

document.getElementById('select-all-header').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="selected_codes"]');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// æ‰¹é‡æ“ä½œç¡®è®¤
document.getElementById('bulk-form').addEventListener('submit', function(e) {
    const selected = document.querySelectorAll('input[name="selected_codes"]:checked');
    const action = document.querySelector('select[name="action"]').value;
    
    if (selected.length === 0) {
        e.preventDefault();
        alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æˆæƒç ');
        return;
    }
    
    if (!action) {
        e.preventDefault();
        alert('è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ');
        return;
    }
    
    const actionText = {
        'delete': 'åˆ é™¤',
        'export': 'å¯¼å‡º'
    };
    
    if (!confirm(`ç¡®è®¤${actionText[action]} ${selected.length} ä¸ªæˆæƒç ï¼Ÿ`)) {
        e.preventDefault();
    }
});

// æœç´¢æ¡†å›è½¦æäº¤
document.getElementById('search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        this.form.submit();
    }
});

// è‡ªåŠ¨ä¿å­˜æœç´¢çŠ¶æ€
const searchForm = document.querySelector('.search-bar');
searchForm.addEventListener('change', function() {
    // å¯ä»¥å®ç°è‡ªåŠ¨æœç´¢åŠŸèƒ½
    // this.submit();
});
</script>
{% endblock %}
