{% extends "base.html" %}

{% block title %}æ·»åŠ æˆæƒç  - ä¹è°±éªŒè¯ç³»ç»Ÿ{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="font-weight: 300;">â• æ·»åŠ æˆæƒç </h1>
    <a href="{{ url_for('admin_codes') }}" class="btn">â† è¿”å›åˆ—è¡¨</a>
</div>

<!-- å•ä¸ªæ·»åŠ  -->
<div class="card">
    <h2>å•ä¸ªæ·»åŠ </h2>
    <form method="POST" action="{{ url_for('admin_add_code') }}">
        <input type="hidden" name="action" value="single">
        
        <div class="form-group">
            <label for="code">æˆæƒç  (12ä½å­—ç¬¦)</label>
            <input type="text" id="code" name="code" maxlength="12" 
                   pattern="[A-Z0-9]{12}" 
                   style="text-transform: uppercase; letter-spacing: 2px; font-family: monospace;"
                   placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ" 
                   value="{{ request.form.code if request.form.action == 'single' }}">
            <small style="color: #666;">åªèƒ½åŒ…å«å¤§å†™å­—æ¯å’Œæ•°å­—ï¼Œç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ</small>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">æ·»åŠ æˆæƒç </button>
            <button type="button" class="btn" onclick="generateCode()">ç”Ÿæˆéšæœºç </button>
        </div>
    </form>
</div>

<!-- æ‰¹é‡æ·»åŠ  -->
<div class="card">
    <h2>æ‰¹é‡æ·»åŠ </h2>
    <form method="POST" action="{{ url_for('admin_add_code') }}">
        <input type="hidden" name="action" value="batch">
        
        <div class="form-group">
            <label for="count">ç”Ÿæˆæ•°é‡</label>
            <input type="number" id="count" name="count" min="1" max="1000" 
                   value="{{ request.form.count if request.form.action == 'batch' else '10' }}" required>
            <small style="color: #666;">ä¸€æ¬¡æœ€å¤šç”Ÿæˆ1000ä¸ªæˆæƒç </small>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">æ‰¹é‡ç”Ÿæˆ</button>
        </div>
    </form>
</div>

<!-- å¯¼å…¥æˆæƒç  -->
<div class="card">
    <h2>å¯¼å…¥æˆæƒç </h2>
    <form method="POST" action="{{ url_for('admin_add_code') }}" enctype="multipart/form-data">
        <input type="hidden" name="action" value="import">
        
        <div class="form-group">
            <label for="import_text">æ–‡æœ¬å¯¼å…¥</label>
            <textarea id="import_text" name="import_text" rows="6" 
                      placeholder="æ¯è¡Œä¸€ä¸ªæˆæƒç ï¼Œæ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š&#10;ABCD12345678&#10;EFGH87654321&#10;æˆ–CSVæ ¼å¼ï¼šæˆæƒç ,åˆ›å»ºæ—¶é—´"
                      style="font-family: monospace;">{{ request.form.import_text if request.form.action == 'import' }}</textarea>
            <small style="color: #666;">æ¯è¡Œä¸€ä¸ªæˆæƒç ï¼Œæˆ–CSVæ ¼å¼ï¼ˆæˆæƒç ,åˆ›å»ºæ—¶é—´ï¼‰</small>
        </div>
        
        <div class="form-group">
            <label for="import_file">æ–‡ä»¶å¯¼å…¥</label>
            <input type="file" id="import_file" name="import_file" accept=".txt,.csv">
            <small style="color: #666;">æ”¯æŒTXTæˆ–CSVæ–‡ä»¶</small>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" name="skip_duplicates" checked> è·³è¿‡é‡å¤çš„æˆæƒç 
            </label>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">å¯¼å…¥æˆæƒç </button>
        </div>
    </form>
</div>

<!-- æœ€è¿‘æ·»åŠ çš„æˆæƒç  -->
{% if recent_codes %}
<div class="card">
    <h2>ğŸ“ æœ€è¿‘æ·»åŠ </h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>æˆæƒç </th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for code in recent_codes %}
                <tr>
                    <td><code>{{ code.code }}</code></td>
                    <td>{{ code.created_date[:19] if code.created_date else '-' }}</td>
                    <td>
                        {% if code.activated %}
                            <span style="color: #007700;">âœ“ å·²æ¿€æ´»</span>
                        {% else %}
                            <span style="color: #666666;">â—‹ æœªæ¿€æ´»</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('admin_code_detail', code=code.code) }}" 
                           class="btn btn-small">è¯¦æƒ…</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- ä½¿ç”¨è¯´æ˜ -->
<div class="card">
    <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
    <div style="color: #666666; line-height: 1.8;">
        <h3>æˆæƒç è§„åˆ™ï¼š</h3>
        <ul style="margin-left: 2rem;">
            <li>é•¿åº¦å¿…é¡»ä¸º12ä½</li>
            <li>åªèƒ½åŒ…å«å¤§å†™å­—æ¯ï¼ˆA-Zï¼‰å’Œæ•°å­—ï¼ˆ0-9ï¼‰</li>
            <li>æ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦ï¼š0ã€Oã€Iã€1</li>
            <li>æ¯ä¸ªæˆæƒç å¿…é¡»å”¯ä¸€</li>
        </ul>
        
        <h3>å¯¼å…¥æ ¼å¼ï¼š</h3>
        <ul style="margin-left: 2rem;">
            <li><strong>çº¯æ–‡æœ¬ï¼š</strong>æ¯è¡Œä¸€ä¸ªæˆæƒç </li>
            <li><strong>CSVæ ¼å¼ï¼š</strong>æˆæƒç ,åˆ›å»ºæ—¶é—´</li>
            <li><strong>ç¤ºä¾‹ï¼š</strong>ABCD12345678,2024-01-01T12:00:00</li>
        </ul>
        
        <h3>æ³¨æ„äº‹é¡¹ï¼š</h3>
        <ul style="margin-left: 2rem;">
            <li>é‡å¤çš„æˆæƒç ä¼šè¢«è‡ªåŠ¨è·³è¿‡ï¼ˆå¦‚æœå‹¾é€‰è·³è¿‡é€‰é¡¹ï¼‰</li>
            <li>æ‰¹é‡ç”Ÿæˆæ—¶ä¼šè‡ªåŠ¨ç¡®ä¿å”¯ä¸€æ€§</li>
            <li>å»ºè®®å®šæœŸå¤‡ä»½æˆæƒç æ•°æ®</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ç”Ÿæˆéšæœºæˆæƒç 
function generateCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // æ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦
    let code = '';
    for (let i = 0; i < 12; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('code').value = code;
}

// è‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™
document.getElementById('code').addEventListener('input', function(e) {
    let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    // æ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦
    value = value.replace(/[01IO]/g, '');
    if (value.length > 12) {
        value = value.substring(0, 12);
    }
    e.target.value = value;
});

// å¯¼å…¥æ–‡æœ¬è‡ªåŠ¨è½¬æ¢
document.getElementById('import_text').addEventListener('input', function(e) {
    let value = e.target.value.toUpperCase();
    e.target.value = value;
});

// æ–‡ä»¶å¯¼å…¥å¤„ç†
document.getElementById('import_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('import_text').value = e.target.result;
        };
        reader.readAsText(file);
    }
});

// è¡¨å•éªŒè¯
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const action = this.querySelector('input[name="action"]').value;
        
        if (action === 'single') {
            const code = this.querySelector('input[name="code"]').value.trim();
            if (code && code.length !== 12) {
                e.preventDefault();
                alert('æˆæƒç é•¿åº¦å¿…é¡»ä¸º12ä½');
                return;
            }
        }
        
        if (action === 'batch') {
            const count = parseInt(this.querySelector('input[name="count"]').value);
            if (count > 1000) {
                e.preventDefault();
                alert('ä¸€æ¬¡æœ€å¤šç”Ÿæˆ1000ä¸ªæˆæƒç ');
                return;
            }
        }
        
        if (action === 'import') {
            const text = this.querySelector('textarea[name="import_text"]').value.trim();
            const file = this.querySelector('input[name="import_file"]').files[0];
            if (!text && !file) {
                e.preventDefault();
                alert('è¯·è¾“å…¥è¦å¯¼å…¥çš„æˆæƒç æˆ–é€‰æ‹©æ–‡ä»¶');
                return;
            }
        }
    });
});

// è‡ªåŠ¨èšç„¦
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('code').focus();
});
</script>
{% endblock %}
