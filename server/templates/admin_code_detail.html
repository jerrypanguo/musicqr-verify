{% extends "base.html" %}

{% block title %}æˆæƒç è¯¦æƒ… - {{ code_info.code }} - ä¹è°±éªŒè¯ç³»ç»Ÿ{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="font-weight: 300;">ğŸ” æˆæƒç è¯¦æƒ…</h1>
    <div>
        <a href="{{ url_for('admin_codes') }}" class="btn">â† è¿”å›åˆ—è¡¨</a>
        <a href="{{ url_for('admin_delete_code', code=code_info.code) }}" 
           class="btn btn-danger"
           onclick="return confirm('ç¡®è®¤åˆ é™¤æ­¤æˆæƒç ï¼Ÿ')">åˆ é™¤</a>
    </div>
</div>

<!-- åŸºæœ¬ä¿¡æ¯ -->
<div class="card">
    <h2>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <h3>æˆæƒç </h3>
            <div style="font-family: monospace; font-size: 1.5em; font-weight: bold; color: #000; background: #f8f8f8; padding: 1rem; border: 2px solid #000; text-align: center; letter-spacing: 2px;">
                {{ code_info.code }}
            </div>
        </div>
        
        <div>
            <h3>çŠ¶æ€</h3>
            <div style="font-size: 1.2em; padding: 1rem;">
                {% if code_info.activated %}
                    <span style="color: #007700; font-weight: bold;">âœ“ å·²æ¿€æ´»</span>
                {% else %}
                    <span style="color: #666666; font-weight: bold;">â—‹ æœªæ¿€æ´»</span>
                {% endif %}
            </div>
        </div>
        
        <div>
            <h3>åˆ›å»ºæ—¶é—´</h3>
            <div style="padding: 1rem;">
                {{ code_info.created_date[:19] if code_info.created_date else '-' }}
            </div>
        </div>
        
        <div>
            <h3>æŸ¥è¯¢æ¬¡æ•°</h3>
            <div style="font-size: 1.5em; font-weight: bold; padding: 1rem;">
                {{ code_info.query_count or 0 }}
            </div>
        </div>
    </div>
</div>

<!-- æ¿€æ´»ä¿¡æ¯ -->
{% if code_info.activated %}
<div class="card">
    <h2>ğŸ¯ æ¿€æ´»ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <h3>æ¿€æ´»æ—¶é—´</h3>
            <div style="padding: 1rem;">
                {{ code_info.activation_date[:19] if code_info.activation_date else '-' }}
            </div>
        </div>
        
        <div>
            <h3>æ¿€æ´»IP</h3>
            <div style="padding: 1rem; font-family: monospace;">
                {{ code_info.activation_ip or '-' }}
            </div>
        </div>
        
        <div>
            <h3>æœ€åæŸ¥è¯¢</h3>
            <div style="padding: 1rem;">
                {{ code_info.last_query_date[:19] if code_info.last_query_date else '-' }}
            </div>
        </div>
        
        <div>
            <h3>è®¾å¤‡ä¿¡æ¯</h3>
            <div style="padding: 1rem; font-size: 0.9em; color: #666;">
                {{ code_info.activation_user_agent[:50] + '...' if code_info.activation_user_agent and code_info.activation_user_agent|length > 50 else (code_info.activation_user_agent or '-') }}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- äºŒç»´ç é¢„è§ˆ -->
<div class="card">
    <h2>ğŸ“± äºŒç»´ç é¢„è§ˆ</h2>
    <div style="text-align: center; padding: 2rem;">
        <div id="qrcode" style="display: inline-block; padding: 2rem; background: #ffffff; border: 2px solid #000;"></div>
        <div style="margin-top: 1rem; color: #666;">
            <p>éªŒè¯URL: <code>{{ request.url_root }}?code={{ code_info.code }}</code></p>
            <p>ç”¨æˆ·æ‰«ææ­¤äºŒç»´ç å³å¯éªŒè¯ä¹è°±çœŸä¼ª</p>
        </div>
    </div>
</div>

<!-- æ“ä½œè®°å½• -->
<div class="card">
    <h2>ğŸ“ æ“ä½œè®°å½•</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                    <th>ç»“æœ</th>
                    <th>IPåœ°å€</th>
                </tr>
            </thead>
            <tbody>
                {% if code_info.activated %}
                <tr>
                    <td>{{ code_info.activation_date[:19] if code_info.activation_date else '-' }}</td>
                    <td>é¦–æ¬¡æ¿€æ´»</td>
                    <td><span style="color: #007700;">æˆåŠŸ</span></td>
                    <td>{{ code_info.activation_ip or '-' }}</td>
                </tr>
                {% endif %}
                
                {% if code_info.last_query_date and code_info.last_query_date != code_info.activation_date %}
                <tr>
                    <td>{{ code_info.last_query_date[:19] if code_info.last_query_date else '-' }}</td>
                    <td>æŸ¥è¯¢éªŒè¯</td>
                    <td><span style="color: #007700;">æˆåŠŸ</span></td>
                    <td>-</td>
                </tr>
                {% endif %}
                
                <tr>
                    <td>{{ code_info.created_date[:19] if code_info.created_date else '-' }}</td>
                    <td>åˆ›å»ºæˆæƒç </td>
                    <td><span style="color: #007700;">æˆåŠŸ</span></td>
                    <td>ç³»ç»Ÿ</td>
                </tr>
                
                {% if not code_info.activated and not code_info.last_query_date %}
                <tr>
                    <td colspan="4" style="text-align: center; color: #666; padding: 2rem;">
                        æ­¤æˆæƒç å°šæœªè¢«ä½¿ç”¨
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="card">
    <h2>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div class="stat-card">
            <span class="stat-number">{{ code_info.query_count or 0 }}</span>
            <div class="stat-label">æ€»æŸ¥è¯¢æ¬¡æ•°</div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">
                {% if code_info.created_date and code_info.activation_date %}
                    {{ ((code_info.activation_date | strptime('%Y-%m-%dT%H:%M:%S')) - (code_info.created_date | strptime('%Y-%m-%dT%H:%M:%S'))).days }}
                {% else %}
                    -
                {% endif %}
            </span>
            <div class="stat-label">æ¿€æ´»é—´éš”(å¤©)</div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">
                {% if code_info.created_date %}
                    {{ ((now | strptime('%Y-%m-%d %H:%M:%S')) - (code_info.created_date | strptime('%Y-%m-%dT%H:%M:%S'))).days }}
                {% else %}
                    -
                {% endif %}
            </span>
            <div class="stat-label">å­˜åœ¨å¤©æ•°</div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">
                {% if code_info.activated %}
                    âœ“
                {% else %}
                    â—‹
                {% endif %}
            </span>
            <div class="stat-label">æ¿€æ´»çŠ¶æ€</div>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿæ“ä½œ -->
<div class="card">
    <h2>âš¡ å¿«é€Ÿæ“ä½œ</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="testVerification()">æµ‹è¯•éªŒè¯</button>
        <button class="btn" onclick="copyCode()">å¤åˆ¶æˆæƒç </button>
        <button class="btn" onclick="copyUrl()">å¤åˆ¶éªŒè¯URL</button>
        <a href="{{ url_for('admin_export', codes=code_info.code) }}" class="btn">å¯¼å‡ºæ•°æ®</a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

#qrcode canvas {
    border: 1px solid #ddd;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥QRç ç”Ÿæˆåº“ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
// ç”ŸæˆäºŒç»´ç 
document.addEventListener('DOMContentLoaded', function() {
    const qrContainer = document.getElementById('qrcode');
    const verifyUrl = '{{ request.url_root }}?code={{ code_info.code }}';
    
    QRCode.toCanvas(verifyUrl, {
        width: 200,
        height: 200,
        color: {
            dark: '#000000',
            light: '#FFFFFF'
        }
    }, function(error, canvas) {
        if (error) {
            qrContainer.innerHTML = '<p style="color: #cc0000;">äºŒç»´ç ç”Ÿæˆå¤±è´¥</p>';
        } else {
            qrContainer.appendChild(canvas);
        }
    });
});

// æµ‹è¯•éªŒè¯
function testVerification() {
    const code = '{{ code_info.code }}';
    fetch(`/api/verify/${code}`)
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                alert(`éªŒè¯æˆåŠŸï¼\nçŠ¶æ€: ${data.activated ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}\næ¶ˆæ¯: ${data.message}`);
            } else {
                alert(`éªŒè¯å¤±è´¥: ${data.message}`);
            }
        })
        .catch(error => {
            alert('æµ‹è¯•å¤±è´¥: ' + error.message);
        });
}

// å¤åˆ¶æˆæƒç 
function copyCode() {
    const code = '{{ code_info.code }}';
    navigator.clipboard.writeText(code).then(() => {
        alert('æˆæƒç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(() => {
        // é™çº§æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('æˆæƒç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
}

// å¤åˆ¶éªŒè¯URL
function copyUrl() {
    const url = '{{ request.url_root }}?code={{ code_info.code }}';
    navigator.clipboard.writeText(url).then(() => {
        alert('éªŒè¯URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(() => {
        // é™çº§æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('éªŒè¯URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
}

// æ·»åŠ æ—¥æœŸè¿‡æ»¤å™¨æ”¯æŒ
{% set now = moment().format('YYYY-MM-DD HH:mm:ss') %}
</script>
{% endblock %}
