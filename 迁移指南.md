# ä¹è°±éªŒè¯ç³»ç»Ÿ - æœåŠ¡å™¨è¿ç§»æŒ‡å—

## ğŸ¯ è¿ç§»æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•å°†ä¹è°±éªŒè¯ç³»ç»Ÿä»ä¸€å°VPSè¿ç§»åˆ°å¦ä¸€å°VPSï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’ŒæœåŠ¡è¿ç»­æ€§ã€‚

## ğŸ“‹ è¿ç§»å‰å‡†å¤‡

### 1. è¿ç§»æ¸…å•

**éœ€è¦è¿ç§»çš„æ•°æ®**ï¼š
- âœ… æ•°æ®åº“æ–‡ä»¶ï¼ˆæˆæƒç æ•°æ®ï¼‰
- âœ… é…ç½®æ–‡ä»¶ï¼ˆAPIå¯†é’¥ã€ç®¡ç†å‘˜è´¦å·ï¼‰
- âœ… æ—¥å¿—æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
- âœ… å¤‡ä»½æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
- âœ… SSLè¯ä¹¦ï¼ˆå¦‚æœä½¿ç”¨Let's Encryptï¼‰

**éœ€è¦å‡†å¤‡çš„ä¿¡æ¯**ï¼š
- ğŸ”‘ æ–°æœåŠ¡å™¨IPåœ°å€
- ğŸŒ åŸŸåç®¡ç†é¢æ¿è®¿é—®æƒé™
- ğŸ“§ SSLè¯ä¹¦ç”³è¯·é‚®ç®±
- ğŸ” ç®¡ç†å‘˜è´¦å·å¯†ç 

### 2. æ–°æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS
- **é…ç½®**: ä¸åŸæœåŠ¡å™¨ç›¸åŒæˆ–æ›´é«˜
- **ç½‘ç»œ**: å…¬ç½‘IPåœ°å€
- **æƒé™**: rootæˆ–sudoè®¿é—®æƒé™

## ğŸ”„ å®Œæ•´è¿ç§»æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå¤‡ä»½åŸæœåŠ¡å™¨æ•°æ®

#### 1.1 åˆ›å»ºæ•°æ®å¤‡ä»½

```bash
# è¿æ¥åˆ°åŸæœåŠ¡å™¨
ssh musicqr@old-server-ip

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ~/migration_backup
cd ~/migration_backup

# å¤‡ä»½æ•°æ®åº“
sudo cp /var/lib/musicqr/musicqr.db ./musicqr.db
sudo chown musicqr:musicqr ./musicqr.db

# å¤‡ä»½é…ç½®æ–‡ä»¶
sudo cp /var/www/musicqr/.env ./env_config

# å¤‡ä»½åº”ç”¨ä»£ç ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰ä¿®æ”¹ï¼‰
sudo cp -r /var/www/musicqr ./app_backup

# å¤‡ä»½Nginxé…ç½®
sudo cp /etc/nginx/sites-available/musicqr ./nginx_config

# å¤‡ä»½systemdæœåŠ¡é…ç½®
sudo cp /etc/systemd/system/musicqr-api.service ./systemd_config

# å¤‡ä»½æ—¥å¿—æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
sudo cp -r /var/log/musicqr ./logs_backup

# å¤‡ä»½å†å²å¤‡ä»½æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
sudo cp -r /var/backups/musicqr ./historical_backups
```

#### 1.2 å¯¼å‡ºæ•°æ®åº“ç»Ÿè®¡

```bash
# å¯¼å‡ºæ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
cd /var/www/musicqr
source venv/bin/activate

python3 -c "
import sqlite3
conn = sqlite3.connect('/var/lib/musicqr/musicqr.db')
cursor = conn.cursor()

# è·å–ç»Ÿè®¡ä¿¡æ¯
cursor.execute('SELECT COUNT(*) FROM auth_codes')
total = cursor.fetchone()[0]

cursor.execute('SELECT COUNT(*) FROM auth_codes WHERE activated = 1')
activated = cursor.fetchone()[0]

print(f'æ€»æˆæƒç æ•°: {total}')
print(f'å·²æ¿€æ´»æ•°: {activated}')
print(f'æ¿€æ´»ç‡: {activated/total*100:.1f}%' if total > 0 else 'æ¿€æ´»ç‡: 0%')

conn.close()
" > ~/migration_backup/db_stats.txt

echo "æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯å·²ä¿å­˜åˆ° db_stats.txt"
```

#### 1.3 åˆ›å»ºè¿ç§»åŒ…

```bash
# åˆ›å»ºå®Œæ•´çš„è¿ç§»åŒ…
cd ~/migration_backup
tar -czf migration_package_$(date +%Y%m%d_%H%M%S).tar.gz \
    musicqr.db \
    env_config \
    nginx_config \
    systemd_config \
    db_stats.txt \
    app_backup/ \
    logs_backup/ \
    historical_backups/

echo "è¿ç§»åŒ…åˆ›å»ºå®Œæˆï¼š"
ls -lh migration_package_*.tar.gz
```

#### 1.4 ä¸‹è½½è¿ç§»åŒ…åˆ°æœ¬åœ°

```bash
# åœ¨æœ¬åœ°æœºå™¨ä¸Šæ‰§è¡Œ
scp musicqr@old-server-ip:~/migration_backup/migration_package_*.tar.gz ./

echo "è¿ç§»åŒ…å·²ä¸‹è½½åˆ°æœ¬åœ°"
```

### ç¬¬äºŒæ­¥ï¼šåœ¨æ–°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ç³»ç»Ÿ

#### 2.1 åŸºç¡€éƒ¨ç½²

```bash
# è¿æ¥åˆ°æ–°æœåŠ¡å™¨
ssh root@new-server-ip

# åˆ›å»ºç”¨æˆ·
adduser musicqr
usermod -aG sudo musicqr
su - musicqr

# ä¸Šä¼ é¡¹ç›®æ–‡ä»¶å’Œè¿ç§»åŒ…
# scp -r ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ/ musicqr@new-server-ip:/home/musicqr/
# scp migration_package_*.tar.gz musicqr@new-server-ip:/home/musicqr/

# è¿è¡ŒåŸºç¡€éƒ¨ç½²
cd ~/ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ
chmod +x server/deploy/setup.sh
sudo ./server/deploy/setup.sh
```

#### 2.2 æ¢å¤æ•°æ®

```bash
# è§£å‹è¿ç§»åŒ…
cd ~
tar -xzf migration_package_*.tar.gz

# åœæ­¢æ–°éƒ¨ç½²çš„æœåŠ¡
sudo systemctl stop musicqr-api

# æ¢å¤æ•°æ®åº“
sudo cp musicqr.db /var/lib/musicqr/musicqr.db
sudo chown musicqr:musicqr /var/lib/musicqr/musicqr.db

# æ¢å¤é…ç½®æ–‡ä»¶
sudo cp env_config /var/www/musicqr/.env
sudo chown musicqr:musicqr /var/www/musicqr/.env
sudo chmod 600 /var/www/musicqr/.env

# éªŒè¯é…ç½®
echo "æ¢å¤çš„é…ç½®ä¿¡æ¯ï¼š"
sudo cat /var/www/musicqr/.env | grep -E "(SECRET_KEY|ADMIN_)"
```

#### 2.3 æ›´æ–°é…ç½®

```bash
# å¦‚æœéœ€è¦æ›´æ–°æŸäº›é…ç½®
sudo nano /var/www/musicqr/.env

# ä¾‹å¦‚æ›´æ–°æ•°æ®åº“è·¯å¾„ã€æ—¥å¿—è·¯å¾„ç­‰
# DATABASE_PATH=/var/lib/musicqr/musicqr.db
# LOG_FILE=/var/log/musicqr/api.log
# BACKUP_DIR=/var/backups/musicqr
```

### ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°DNSå’ŒSSL

#### 3.1 æ›´æ–°DNSè§£æ

```bash
# åœ¨åŸŸåç®¡ç†é¢æ¿ä¸­æ›´æ–°Aè®°å½•
# ç±»å‹: A
# åç§°: verify.yuzeguitar.me
# å€¼: new-server-ip
# TTL: 300 (5åˆ†é’Ÿï¼Œä¾¿äºå¿«é€Ÿç”Ÿæ•ˆ)

# éªŒè¯DNSè§£æ
nslookup verify.yuzeguitar.me
dig verify.yuzeguitar.me

# ç­‰å¾…DNSä¼ æ’­ï¼ˆé€šå¸¸5-30åˆ†é’Ÿï¼‰
```

#### 3.2 ç”³è¯·æ–°çš„SSLè¯ä¹¦

```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Šç”³è¯·SSLè¯ä¹¦
sudo certbot --nginx -d verify.yuzeguitar.me --email your-email@example.com --agree-tos --non-interactive

# éªŒè¯SSLè¯ä¹¦
sudo certbot certificates

# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

### ç¬¬å››æ­¥ï¼šå¯åŠ¨å’ŒéªŒè¯æœåŠ¡

#### 4.1 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨APIæœåŠ¡
sudo systemctl start musicqr-api
sudo systemctl enable musicqr-api

# é‡å¯Nginx
sudo systemctl restart nginx

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status musicqr-api --no-pager
sudo systemctl status nginx --no-pager
```

#### 4.2 éªŒè¯æ•°æ®å®Œæ•´æ€§

```bash
# éªŒè¯æ•°æ®åº“æ•°æ®
cd /var/www/musicqr
source venv/bin/activate

python3 -c "
import sqlite3
conn = sqlite3.connect('/var/lib/musicqr/musicqr.db')
cursor = conn.cursor()

cursor.execute('SELECT COUNT(*) FROM auth_codes')
total = cursor.fetchone()[0]

cursor.execute('SELECT COUNT(*) FROM auth_codes WHERE activated = 1')
activated = cursor.fetchone()[0]

print(f'è¿ç§»åç»Ÿè®¡:')
print(f'æ€»æˆæƒç æ•°: {total}')
print(f'å·²æ¿€æ´»æ•°: {activated}')
print(f'æ¿€æ´»ç‡: {activated/total*100:.1f}%' if total > 0 else 'æ¿€æ´»ç‡: 0%')

conn.close()
"

# å¯¹æ¯”åŸæœåŠ¡å™¨çš„ç»Ÿè®¡ä¿¡æ¯
echo "åŸæœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯ï¼š"
cat ~/db_stats.txt
```

#### 4.3 åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•APIæ¥å£
curl https://verify.yuzeguitar.me/api/status

# æµ‹è¯•å‰ç«¯é¡µé¢
curl -I https://verify.yuzeguitar.me/

# æµ‹è¯•ç®¡ç†åå°
curl -I https://verify.yuzeguitar.me/admin

# è¿è¡Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•
cd ~/ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ
python3 scripts/test_system.py --url https://verify.yuzeguitar.me
```

### ç¬¬äº”æ­¥ï¼šæ›´æ–°å®¢æˆ·ç«¯é…ç½®

#### 5.1 è·å–æ–°çš„APIå¯†é’¥

```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Šè·å–APIå¯†é’¥
cd /var/www/musicqr
source venv/bin/activate

python3 -c "
import hashlib
import hmac

with open('.env', 'r') as f:
    for line in f:
        if line.startswith('SECRET_KEY='):
            secret_key = line.split('=', 1)[1].strip()
            break

salt = 'musicqr_api_salt_2024'
api_key = hmac.new(secret_key.encode(), salt.encode(), hashlib.sha256).hexdigest()

print('æ–°æœåŠ¡å™¨é…ç½®ä¿¡æ¯:')
print(f'SECRET_KEY: {secret_key}')
print(f'API_KEY: {api_key}')
print()
print('å®¢æˆ·ç«¯é…ç½®å‘½ä»¤:')
print(f'export CLIENT_SECRET_KEY=\"{secret_key}\"')
print(f'export VPS_URL=\"https://verify.yuzeguitar.me\"')
print(f'export API_KEY_SALT=\"{salt}\"')
"
```

#### 5.2 æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥

```bash
# åœ¨æœ¬åœ°å®¢æˆ·ç«¯æµ‹è¯•
export CLIENT_SECRET_KEY="your-secret-key"
export VPS_URL="https://verify.yuzeguitar.me"
export API_KEY_SALT="musicqr_api_salt_2024"

# æµ‹è¯•è¿æ¥
cd ä¹è°±éªŒè¯ç³»ç»Ÿ-VPSç‰ˆ/client
python3 -c "
from generate_codes import VPSQRCodeGenerator
generator = VPSQRCodeGenerator()
success, message = generator.check_vps_connection()
print(message)
"
```

## ğŸ”„ é›¶åœæœºè¿ç§»ï¼ˆé«˜çº§ï¼‰

å¦‚æœéœ€è¦å®ç°é›¶åœæœºè¿ç§»ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

### 1. åŒæœåŠ¡å™¨è¿è¡Œ

```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ç³»ç»Ÿä½†ä½¿ç”¨ä¸åŒåŸŸå
# ä¾‹å¦‚: new.verify.yuzeguitar.me

# åŒæ­¥æ•°æ®åˆ°æ–°æœåŠ¡å™¨
# ä½¿ç”¨æ•°æ®åº“å¤åˆ¶æˆ–å®šæœŸåŒæ­¥è„šæœ¬

# æµ‹è¯•æ–°æœåŠ¡å™¨åŠŸèƒ½å®Œæ•´æ€§
```

### 2. æµé‡åˆ‡æ¢

```bash
# æ–¹æ³•1: DNSåˆ‡æ¢ï¼ˆæœ‰ä¼ æ’­å»¶è¿Ÿï¼‰
# ç›´æ¥æ›´æ–°DNSè®°å½•æŒ‡å‘æ–°æœåŠ¡å™¨

# æ–¹æ³•2: è´Ÿè½½å‡è¡¡å™¨åˆ‡æ¢ï¼ˆæ¨èï¼‰
# ä½¿ç”¨Cloudflareæˆ–å…¶ä»–CDNæœåŠ¡
# é€æ­¥å°†æµé‡ä»æ—§æœåŠ¡å™¨åˆ‡æ¢åˆ°æ–°æœåŠ¡å™¨

# æ–¹æ³•3: åå‘ä»£ç†åˆ‡æ¢
# åœ¨æ—§æœåŠ¡å™¨ä¸Šé…ç½®åå‘ä»£ç†æŒ‡å‘æ–°æœåŠ¡å™¨
```

## ğŸ›¡ï¸ è¿ç§»åå®‰å…¨æ£€æŸ¥

### 1. å®‰å…¨é…ç½®éªŒè¯

```bash
# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo ufw status

# æ£€æŸ¥SSLè¯ä¹¦
sudo certbot certificates

# æ£€æŸ¥æœåŠ¡æƒé™
ls -la /var/www/musicqr/
ls -la /var/lib/musicqr/

# æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™
ls -la /var/www/musicqr/.env
```

### 2. æ€§èƒ½æµ‹è¯•

```bash
# å‹åŠ›æµ‹è¯•APIæ¥å£
for i in {1..100}; do
    curl -s https://verify.yuzeguitar.me/api/status > /dev/null &
done
wait

# æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨
htop
df -h
free -h
```

## ğŸ“Š è¿ç§»åç»´æŠ¤

### 1. ç›‘æ§è®¾ç½®

```bash
# è®¾ç½®æ—¥å¿—è½®è½¬
sudo tee /etc/logrotate.d/musicqr << EOF
/var/log/musicqr/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 musicqr musicqr
    postrotate
        systemctl reload musicqr-api
    endscript
}
EOF

# è®¾ç½®å®šæ—¶å¤‡ä»½
(crontab -l 2>/dev/null; echo "0 2 * * * cp /var/lib/musicqr/musicqr.db /var/backups/musicqr/backup_\$(date +\%Y\%m\%d).db") | crontab -
```

### 2. æ¸…ç†åŸæœåŠ¡å™¨

```bash
# ç¡®è®¤æ–°æœåŠ¡å™¨è¿è¡Œæ­£å¸¸åï¼Œæ¸…ç†åŸæœåŠ¡å™¨
# ä¿ç•™å¤‡ä»½æ–‡ä»¶ä¸€æ®µæ—¶é—´ï¼ˆå»ºè®®30å¤©ï¼‰

# åœæ­¢åŸæœåŠ¡å™¨æœåŠ¡
sudo systemctl stop musicqr-api nginx

# å¤‡ä»½é‡è¦æ•°æ®åˆ°å…¶ä»–ä½ç½®
# ç„¶åå¯ä»¥å®‰å…¨åœ°åˆ é™¤æˆ–é‡æ–°é…ç½®åŸæœåŠ¡å™¨
```

## ğŸ› è¿ç§»æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿ç§»å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
   ls -la /var/lib/musicqr/musicqr.db
   
   # é‡æ–°è®¾ç½®æƒé™
   sudo chown musicqr:musicqr /var/lib/musicqr/musicqr.db
   ```

2. **SSLè¯ä¹¦ç”³è¯·å¤±è´¥**
   ```bash
   # æ£€æŸ¥DNSè§£æ
   nslookup verify.yuzeguitar.me
   
   # æ£€æŸ¥é˜²ç«å¢™
   sudo ufw status
   
   # æ‰‹åŠ¨ç”³è¯·è¯ä¹¦
   sudo certbot certonly --webroot -w /var/www/musicqr/web -d verify.yuzeguitar.me
   ```

3. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
   sudo journalctl -u musicqr-api -n 50
   
   # æ£€æŸ¥é…ç½®æ–‡ä»¶
   cat /var/www/musicqr/.env
   ```

## ğŸ“ è¿ç§»æ”¯æŒ

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š
- **å¼€å‘è€…**: Yuze Pan
- **å¾®ä¿¡**: Guitar_yuze
- **å»ºè®®**: å…ˆåœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œè¿ç§»æ¼”ç»ƒ

---

**æˆåŠŸè¿ç§»åï¼Œä½ çš„ä¹è°±éªŒè¯ç³»ç»Ÿå°†åœ¨æ–°æœåŠ¡å™¨ä¸Šç¨³å®šè¿è¡Œï¼** ğŸ‰
